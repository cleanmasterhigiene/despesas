<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Master</title>
    <style>
        /* Estilos Base */
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f8; margin: 0; color: #333; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        header { background-color: #2980b9; color: white; padding: 15px 20px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 1.2rem; text-align: center; flex-grow: 1; }
        .back-button { color: white; text-decoration: none; font-size: 1.5rem; position: absolute; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2, h3, h4 { color: #2c3e50; margin-top: 0; }
        h4 { font-size: 1rem; color: #34495e; border-bottom: 1px solid #ecf0f1; padding-bottom: 8px; margin-bottom: 15px; }
        .divider { height: 1px; background-color: #ecf0f1; margin: 20px 0; }
        label { font-weight: 500; font-size: 0.9rem; color: #34495e; margin-bottom: 5px; display: block; }
        .hidden { display: none; }
        .empty-state { text-align: center; color: #95a5a6; padding: 20px; background-color: #f9f9f9; border-radius: 8px; }

        /* Abas */
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #ddd; margin-bottom: 20px; background-color: #fff; border-radius: 8px 8px 0 0; }
        .tab-link { flex-grow: 1; background: none; border: none; padding: 15px 10px; cursor: pointer; font-size: 0.95rem; color: #7f8c8d; border-bottom: 3px solid transparent; text-align: center; }
        .tab-link.active { color: #2980b9; border-bottom-color: #2980b9; font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Formulários e Botões */
        form { display: flex; flex-direction: column; gap: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; font-family: 'Roboto', sans-serif; }
        .inline-fields { display: flex; gap: 10px; align-items: center; }
        button, .action-btn { padding: 15px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button.submit-btn { background-color: #27ae60; width: 100%; margin-top: 10px;}
        button.delete-btn, .delete-btn { background-color: #e74c3c; color: white; border:none; }
        
        /* Botões de Ação Pequenos (Editar/Excluir) */
        .action-btn-small { padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; margin-left: 5px; }
        .edit-btn { background-color: #f39c12; }

        /* Controles de Insumos */
        .add-insumo-controls { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; align-items: center; }
        #sp-add-insumo-btn { padding: 12px; }

        /* Listas de Itens */
        .item-vinculado { display: flex; justify-content: space-between; align-items: center; background-color: #ecf0f1; padding: 8px 12px; border-radius: 5px; margin-bottom: 8px; font-size: 0.9rem; }
        .servico-padrao-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ecf0f1; }
        .item-info .nome { font-weight: 500; color: #2c3e50; }
        .item-info .custo, .item-info .tempo { color: #7f8c8d; font-size: 0.85rem; }
        .insumo-item { display: grid; grid-template-columns: 1fr auto; gap: 10px 20px; align-items: center; padding: 10px; border-bottom: 1px solid #ecf0f1; }
        .insumo-item .nome { font-weight: 500; grid-column: 1 / -1; }
        .insumo-item .editable-fields { display: flex; align-items: center; gap: 5px; }
        .insumo-item .editable-fields input { width: 80px; text-align: center; padding: 8px; }
        .insumo-item .insumo-custo-calculado { font-size: 0.85rem; color: #7f8c8d; justify-self: start; }
        .insumo-item .delete-btn { justify-self: end; grid-row: 2 / 4; width: 24px; height: 24px; padding: 0; border-radius: 50%;}

        /* Orçamento e Lançamento */
        .orcamento-itens-container { border: 1px solid #eee; border-radius: 8px; margin-top: 15px; padding: 10px; min-height: 50px; }
        .orcamento-item { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; background-color: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .orcamento-item .item-preco { text-align: right; }
        .orcamento-item .item-preco label { font-size: 0.8rem; display: block; margin-bottom: 2px; color: #7f8c8d; }
        .orcamento-item .item-preco-input { width: 100px; padding: 8px; text-align: right; }
        .finance-summary { background-color: #f9fafb; padding: 15px; border-radius: 8px; }
        .finance-row { display: flex; justify-content: space-between; font-size: 1.1rem; padding: 8px 0; border-bottom: 1px solid #ecf0f1; }
        .finance-row:last-child { border-bottom: none; }
        .finance-row.lucro { font-size: 1.2rem; font-weight: bold; }
        .finance-row.lucro strong { color: #27ae60; }

        /* Aba Clientes */
        .cliente-list-item { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 15px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s; }
        .cliente-list-item:hover { background-color: #f5f5f5; }
        .cliente-actions button { margin-left: 10px; }
        #cliente-detalhes-nome { border-bottom: 2px solid #2980b9; padding-bottom: 10px; margin-bottom: 15px; }
        .historico-servico-item { background-color: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9rem; }
        .historico-servico-item .data { font-weight: bold; }
        #novo-orcamento-cliente-btn { width: 100%; margin-bottom: 15px; }
        
        /* Loader */
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Notificação (Toast) */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #27ae60; }
        .toast.error { background-color: #e74c3c; }
    </style>
</head>
<body>
    <div id="loader" class="loader-overlay" style="display: none;"><div class="loader"></div></div>
    <div id="toast-container"></div>

    <header>
        <a href="/despesas/" class="back-button">&larr; Voltar</a>
        <h1>Clean Master</h1>
    </header>

    <main class="container">
        <div class="tabs">
            <button class="tab-link active" data-tab="Lancamento">Orçamento</button>
            <button class="tab-link" data-tab="Clientes">Clientes</button>
            <button class="tab-link" data-tab="Servicos">Serviços</button>
            <button class="tab-link" data-tab="Insumos">Insumos</button>
        </div>

        <div id="Lancamento" class="tab-content active">
            </div>

        <div id="Clientes" class="tab-content">
            <div class="card">
                <h3>Meus Clientes</h3>
                <input type="text" id="clientes-filter-input" placeholder="Filtrar clientes...">
                <div id="clientes-lista"></div>
            </div>
            <div id="cliente-detalhes-container" class="hidden">
                 <div class="card">
                     <h3 id="cliente-detalhes-nome"></h3>
                     <button id="novo-orcamento-cliente-btn">Novo Orçamento para este Cliente</button>
                     <div class="divider"></div>
                     <h4>Histórico de Serviços</h4>
                     <div id="cliente-detalhes-historico"></div>
                 </div>
            </div>
        </div>

        <div id="Servicos" class="tab-content">
            </div>

        <div id="Insumos" class="tab-content">
            </div>
    </main>
    
    <script src="/despesas/js/github-api.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- STATE & API ---
        const api = new GitHubAPI();
        const GITHUB_FILE_PATH = 'data/cleanmaster.json';
        let appData = { insumos: [], servicosPadrao: [], clientes: [], servicosPrestados: [] };
        let fileSHA = null;
        let orcamentoAtual = { cliente: { id: null, nome: null }, servicos: [] };
        let insumosVinculadosCache = [];
        let clienteSelecionadoId = null;
        const loader = document.getElementById('loader');

        // --- HELPERS (Notificações, UI, Cálculos) ---
        // (Colar aqui as funções showLoader, showToast, calcularCustoTotalServicoPadrao)
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            // (Colar aqui a função renderAll)
        }

        function renderClientesList(filter = '') {
            const lista = document.getElementById('clientes-lista');
            if(!lista) return;
            lista.innerHTML = '';
            const filtered = (appData.clientes || []).filter(c => c.nome.toLowerCase().includes(filter.toLowerCase()));
            if (filtered.length === 0) {
                 lista.innerHTML = (filter === '') ? '<p class="empty-state">Nenhum cliente cadastrado.</p>' : '<p class="empty-state">Nenhum cliente encontrado.</p>';
                return;
            }
            filtered.forEach(cliente => {
                const item = document.createElement('div');
                item.className = 'cliente-list-item';
                item.dataset.id = cliente.id;
                item.innerHTML = `
                    <span class="cliente-nome">${cliente.nome}</span>
                    <div class="cliente-actions">
                        <button class="action-btn-small edit-btn" data-id="${cliente.id}">Editar</button>
                        <button class="action-btn-small delete-btn" data-id="${cliente.id}">Excluir</button>
                    </div>
                `;
                // Adiciona o listener de clique no nome do cliente, não no container todo
                item.querySelector('.cliente-nome').addEventListener('click', () => {
                    clienteSelecionadoId = cliente.id;
                    renderClienteDetalhes(cliente.id);
                });
                lista.appendChild(item);
            });
        }
        
        function renderClienteDetalhes(clienteId) {
            const historico = (appData.servicosPrestados || []).filter(sp => sp.clienteId === clienteId).sort((a,b) => new Date(b.data) - new Date(a.data));
            const cliente = appData.clientes.find(c => c.id === clienteId);
            const nomeEl = document.getElementById('cliente-detalhes-nome'); if (nomeEl) nomeEl.textContent = `Detalhes de: ${cliente.nome}`;
            const container = document.getElementById('cliente-detalhes-historico'); if (!container) return; container.innerHTML = '';
            if (historico.length > 0) {
                historico.forEach(h => {
                    const item = document.createElement('div'); item.className = 'historico-servico-item';
                    const dataFormatada = h.data ? new Date(h.data+'T00:00:00').toLocaleDateString('pt-BR') : 'Data não informada';
                    item.innerHTML = `<span class="data">${dataFormatada}:</span> ${(h.servicos || []).map(s=>s.nome).join(', ')} - <strong>Total: R$${h.precoTotal.toFixed(2)}</strong>`;
                    container.appendChild(item);
                });
            } else { container.innerHTML = '<p class="empty-state">Nenhum serviço registrado.</p>'; }
            document.getElementById('cliente-detalhes-container')?.classList.remove('hidden');
        }

        // (Colar aqui o restante das funções de RENDER)

        // --- SETUP EVENT LISTENERS ---
        function setupEventListeners() {
            // (Colar aqui todos os Event Listeners anteriores)
            document.getElementById('clientes-lista')?.addEventListener('click', async (e) => {
                const clienteId = parseInt(e.target.dataset.id);
                
                if (e.target.matches('.delete-btn')) {
                    if (!confirm('Tem certeza que deseja excluir este cliente? O histórico de serviços dele será mantido, mas não será mais vinculado.')) return;
                    appData.clientes = appData.clientes.filter(c => c.id !== clienteId);
                    await saveData(`Excluído cliente ID: ${clienteId}`);
                    document.getElementById('cliente-detalhes-container').classList.add('hidden');
                    renderAll();
                }

                if (e.target.matches('.edit-btn')) {
                    const cliente = appData.clientes.find(c => c.id === clienteId);
                    const novoNome = prompt('Digite o novo nome para o cliente:', cliente.nome);
                    if (novoNome && novoNome.trim() !== '') {
                        cliente.nome = novoNome.trim();
                        appData.servicosPrestados.forEach(sp => {
                            if (sp.clienteId === clienteId) sp.clienteNome = cliente.nome;
                        });
                        await saveData(`Editado nome do cliente ID: ${clienteId}`);
                        renderAll();
                    }
                }
            });

            document.getElementById('novo-orcamento-cliente-btn')?.addEventListener('click', () => {
                if (!clienteSelecionadoId) return;
                const cliente = appData.clientes.find(c => c.id === clienteSelecionadoId);
                if (!cliente) return;
                
                orcamentoAtual = { cliente: { id: cliente.id, nome: cliente.nome }, servicos: [] };
                
                document.querySelector('.tab-link[data-tab="Lancamento"]').click();
                
                document.getElementById('cliente-search').value = cliente.nome;
                document.getElementById('cliente-new-name').classList.add('hidden');
                document.getElementById('cliente-select').classList.add('hidden');
                renderOrcamentoAtual();
            });
        }
        
        // --- DATA PERSISTENCE ---
        // (Colar aqui a função saveData)

        // --- INICIALIZAÇÃO ---
        // (Colar aqui a função init)
        
        init();
    });
    </script>
</body>
</html>
